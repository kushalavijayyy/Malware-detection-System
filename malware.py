import os
import shutil
import pandas as pd
import datetime
import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext

# Function to scan the directory
def scan_directory(directory):
    for root, _, files in os.walk(directory):
        for file in files:
            filepath = os.path.join(root, file)
            yield filepath

# Function to load malware signatures from a file
def load_signatures(filepath):
    with open(filepath, 'r') as file:
        signatures = file.read().splitlines()
    return signatures

# Function to scan a file for malware signatures
def scan_file(filepath, signatures):
    try:
        with open(filepath, 'rb') as file:
            content = file.read()
            for signature in signatures:
                if signature.encode() in content:
                    return True
    except Exception as e:
        print(f"Error reading file {filepath}: {e}")
    return False

# Function to log suspicious files to a CSV file
def log_suspicious_files(logfile, suspicious_files):
    df = pd.DataFrame(suspicious_files, columns=['File Path'])
    df['Detection Time'] = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    df.to_csv(logfile, index=False)

# Function to quarantine suspicious files
def quarantine_file(filepath, quarantine_dir):
    if not os.path.exists(quarantine_dir):
        os.makedirs(quarantine_dir)
    shutil.move(filepath, os.path.join(quarantine_dir, os.path.basename(filepath)))

# Function to handle scanning process
def run_scan():
    directory = filedialog.askdirectory()
    if not directory:
        return
    results.delete(1.0, tk.END)
    status_label.config(text="Scanning...")
    root.update_idletasks()
    suspicious_files = []
    signatures = load_signatures('signatures.txt')
    for filepath in scan_directory(directory):
        if scan_file(filepath, signatures):
            suspicious_files.append(filepath)
            quarantine = messagebox.askyesno("Quarantine", f"Do you want to quarantine {filepath}?")
            if quarantine:
                quarantine_file(filepath, quarantine_dir)
    log_suspicious_files('suspicious_files_log.csv', suspicious_files)
    if suspicious_files:
        results.insert(tk.END, "Suspicious files found:\n")
        for filepath in suspicious_files:
            results.insert(tk.END, f"{filepath}\n")
    else:
        results.insert(tk.END, "No suspicious files found.")
    status_label.config(text="Scan complete.")

# Create GUI
root = tk.Tk()
root.title("Malware Detection System")
frame = tk.Frame(root)
frame.pack(pady=10)
scan_button = tk.Button(frame, text="Scan Directory", command=run_scan, font=('Arial', 14))
scan_button.pack(pady=5)
results_label = tk.Label(frame, text="Scan Results:", font=('Arial', 12))
results_label.pack(pady=5)
results = scrolledtext.ScrolledText(frame, width=80, height=20, font=('Arial', 10))
results.pack(pady=5)
status_label = tk.Label(root, text="", font=('Arial', 10), fg="blue")
status_label.pack(pady=5)
quarantine_dir = os.path.join(os.getcwd(), 'quarantine')
root.mainloop()
